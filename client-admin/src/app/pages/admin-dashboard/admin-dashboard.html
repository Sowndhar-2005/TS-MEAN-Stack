<!-- Admin Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-white sticky-top shadow-sm" style="height: 70px;">
  <div class="container-fluid px-4">
    <div class="d-flex align-items-center gap-3">
       <div class="d-flex align-items-center justify-content-center bg-dark rounded-circle p-2 shadow" style="width: 40px; height: 40px;">
        <i class="bi bi-shield-lock-fill text-white fs-5"></i>
      </div>
      <div class="d-flex flex-column">
        <span class="navbar-brand mb-0 fw-bold lh-1">Admin Panel</span>
        <small class="text-muted" style="font-size: 0.75rem;">Campus Canteen</small>
      </div>
    </div>
    
    <button class="btn btn-outline-danger btn-sm rounded-pill px-3 fw-bold" (click)="logout()">
        <i class="bi bi-box-arrow-right me-1"></i> Logout
    </button>
  </div>
</nav>

<!-- Main Container -->
<div class="container-fluid px-4 py-3" style="height: calc(100vh - 70px); overflow: hidden;">
    
    <!-- Top Header & Actions -->
    <div class="d-flex align-items-center justify-content-between gap-3 mb-4">
        <div class="d-flex align-items-center gap-3 flex-grow-1">
             <h2 class="fw-bold mb-0 text-dark">
                {{ activeTab() === 'stats' ? 'Dashboard Overview' : 'User Management' }}
            </h2>

            <!-- Search Bar (Visible only on Users tab) -->
            @if(activeTab() === 'users') {
                 <div class="position-relative ms-4" style="width: 300px;">
                    <span class="position-absolute top-50 start-0 translate-middle-y ms-3 text-muted">
                        <i class="bi bi-search"></i>
                    </span>
                    <input 
                        type="text" 
                        [ngModel]="searchQuery()" 
                        (ngModelChange)="searchQuery.set($event); onSearch()" 
                        class="form-control ps-5 rounded-pill border-0 shadow-sm bg-white" 
                        placeholder="Search users..." 
                    >
                    @if (searchQuery()) {
                        <span class="position-absolute top-50 end-0 translate-middle-y me-3 text-secondary cursor-pointer" (click)="searchQuery.set(''); onSearch()">
                            <i class="bi bi-x-circle-fill"></i>
                        </span>
                    }
                </div>
            }
        </div>

        @if(activeTab() === 'stats') {
             <button class="btn btn-light shadow-sm rounded-pill text-primary fw-bold" (click)="loadDashboard()">
                <i class="bi bi-arrow-clockwise me-1"></i> Refresh Data
             </button>
        }
    </div>

    <div class="row g-4" style="height: calc(100% - 60px);">
        
        <!-- Sidebar Navigation (Left Column) -->
        <div class="col-lg-3 col-xl-2">
             <div class="d-flex flex-column gap-3">
                 <!-- Navigation Card -->
                 <div class="card border-0 shadow-sm rounded-4 p-2">
                     <div class="d-flex flex-column gap-1">
                         <button 
                            (click)="setActiveTab('stats')"
                            class="btn w-100 d-flex align-items-center gap-3 p-3 rounded-3 border-0 text-start transition-all"
                            [class.bg-primary]="activeTab() === 'stats'"
                            [class.text-white]="activeTab() === 'stats'"
                            [class.bg-transparent]="activeTab() !== 'stats'"
                            [class.text-secondary]="activeTab() !== 'stats'"
                         >
                            <i class="bi bi-grid-1x2-fill fs-5"></i>
                            <span class="fw-bold">Overview</span>
                         </button>

                         <button 
                            (click)="setActiveTab('users')"
                            class="btn w-100 d-flex align-items-center gap-3 p-3 rounded-3 border-0 text-start transition-all"
                            [class.bg-primary]="activeTab() === 'users'"
                            [class.text-white]="activeTab() === 'users'"
                            [class.bg-transparent]="activeTab() !== 'users'"
                            [class.text-secondary]="activeTab() !== 'users'"
                         >
                            <i class="bi bi-people-fill fs-5"></i>
                            <span class="fw-bold">Users</span>
                         </button>
                     </div>
                 </div>

                 <!-- Mini Stats Card (Optional) -->
                 @if(dashboardStats()) {
                    <div class="card border-0 shadow-sm rounded-4 p-3 bg-primary bg-opacity-10">
                        <div class="d-flex align-items-center gap-3 mb-2">
                             <div class="bg-primary text-white rounded-circle p-2 d-flex align-items-center justify-content-center" style="width:32px; height:32px;">
                                 <i class="bi bi-activity"></i>
                             </div>
                             <span class="fw-bold text-primary small">System Status</span>
                        </div>
                        <h4 class="fw-bold mb-0 text-dark">{{ dashboardStats()!.totalUsers }}</h4>
                        <small class="text-muted">Total Active Users</small>
                    </div>
                 }
             </div>
        </div>

        <!-- Main View Area (Right Column) -->
        <div class="col-lg-9 col-xl-10 h-100">
             <div style="height: 100%; overflow-y: auto; padding-bottom: 50px;">
                
                <!-- Stats View -->
                @if (activeTab() === 'stats' && dashboardStats()) {
                     <div class="row g-4 mb-4">
                         <!-- Stat Cards -->
                         <div class="col-md-3">
                             <div class="card border-0 shadow-sm rounded-4 p-4 h-100 bg-white hover-card">
                                 <div class="d-flex justify-content-between align-items-start mb-3">
                                     <div class="bg-info bg-opacity-10 text-info p-3 rounded-4">
                                         <i class="bi bi-people-fill fs-4"></i>
                                     </div>
                                     <span class="badge bg-success-subtle text-success rounded-pill px-3">+New</span>
                                 </div>
                                 <h2 class="fw-bold mb-1">{{ dashboardStats()!.totalUsers }}</h2>
                                 <p class="text-muted mb-0 small fw-bold">Total Users</p>
                             </div>
                         </div>

                         <div class="col-md-3">
                             <div class="card border-0 shadow-sm rounded-4 p-4 h-100 bg-white hover-card">
                                 <div class="d-flex justify-content-between align-items-start mb-3">
                                     <div class="bg-warning bg-opacity-10 text-warning p-3 rounded-4">
                                         <i class="bi bi-sun-fill fs-4"></i>
                                     </div>
                                 </div>
                                 <h2 class="fw-bold mb-1">{{ dashboardStats()!.totalDayScholars }}</h2>
                                 <p class="text-muted mb-0 small fw-bold">Day Scholars</p>
                             </div>
                         </div>

                         <div class="col-md-3">
                             <div class="card border-0 shadow-sm rounded-4 p-4 h-100 bg-white hover-card">
                                 <div class="d-flex justify-content-between align-items-start mb-3">
                                     <div class="bg-secondary bg-opacity-10 text-secondary p-3 rounded-4">
                                         <i class="bi bi-moon-stars-fill fs-4"></i>
                                     </div>
                                 </div>
                                 <h2 class="fw-bold mb-1">{{ dashboardStats()!.totalHostellers }}</h2>
                                 <p class="text-muted mb-0 small fw-bold">Hostellers</p>
                             </div>
                         </div>

                         <div class="col-md-3">
                             <div class="card border-0 shadow-sm rounded-4 p-4 h-100 bg-white hover-card">
                                 <div class="d-flex justify-content-between align-items-start mb-3">
                                     <div class="bg-success bg-opacity-10 text-success p-3 rounded-4">
                                         <i class="bi bi-wallet2 fs-4"></i>
                                     </div>
                                 </div>
                                 <h2 class="fw-bold mb-1">{{ dashboardStats()!.totalPointsDistributed }}</h2>
                                 <p class="text-muted mb-0 small fw-bold">Total Points</p>
                             </div>
                         </div>
                     </div>
                     
                     <!-- Placeholder for Charts or Recent Logs -->
                     <div class="card border-0 shadow-sm rounded-4 p-4">
                         <h5 class="fw-bold mb-4">Detailed Analytics</h5>
                         <div class="text-center py-5 text-muted bg-light rounded-4">
                             <i class="bi bi-bar-chart-line display-4 mb-3 d-block"></i>
                             Analytics charts coming soon
                         </div>
                     </div>
                }

                <!-- Users View -->
                @if (activeTab() === 'users') {
                    
                    <!-- Filters -->
                    <!-- Filters & Actions -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex gap-2">
                            <button (click)="onFilterChange('all')" [class.bg-dark]="filterType() === 'all'" [class.text-white]="filterType() === 'all'" class="btn btn-light rounded-pill px-4 fw-bold">All</button>
                            <button (click)="onFilterChange('dayscholar')" [class.bg-warning]="filterType() === 'dayscholar'" [class.text-dark]="filterType() === 'dayscholar'" class="btn btn-light rounded-pill px-4 fw-bold">Day Scholars</button>
                            <button (click)="onFilterChange('hosteller')" [class.bg-secondary]="filterType() === 'hosteller'" [class.text-white]="filterType() === 'hosteller'" class="btn btn-light rounded-pill px-4 fw-bold">Hostellers</button>
                        </div>
                        
                        <button class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm" (click)="openCreateUserModal()">
                            <i class="bi bi-person-plus-fill me-2"></i> Add User
                        </button>
                    </div>

                    @if (loading()) {
                        <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
                    } @else {
                        <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4">
                            @for (user of filteredUsers(); track user.id) {
                                <div class="col">
                                    <div class="card h-100 border-0 shadow-sm rounded-4 overflow-hidden hover-card" (click)="openUserDetailModal(user)">
                                        <div class="card-body p-4">
                                            <div class="d-flex align-items-center gap-3 mb-4">
                                                <div class="user-avatar-placeholder rounded-circle shadow-sm" [style.background]="getRandomGradient(user.id)">
                                                    {{ getUserInitials(user.name) }}
                                                </div>
                                                <div class="flex-grow-1 overflow-hidden">
                                                    <h5 class="fw-bold mb-1 text-truncate">{{ user.name }}</h5>
                                                    <div class="d-flex align-items-center gap-2">
                                                        <span class="badge rounded-pill fw-normal" [class.bg-warning]="user.userType === 'dayscholar'" [class.text-dark]="user.userType === 'dayscholar'" [class.bg-secondary]="user.userType === 'hosteller'">
                                                            {{ user.userType }}
                                                        </span>
                                                        <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">{{ user.registrationNumber }}</small>
                                                    </div>
                                                </div>
                                            </div>

                                             <div class="p-3 bg-light rounded-4 mb-3">
                                                 <small class="text-muted fw-bold d-block mb-1 text-uppercase" style="font-size: 0.7rem;">Wallet Balance</small>
                                                 <h3 class="fw-bold text-dark mb-0">₹{{ user.walletBalance }}</h3>
                                            </div>

                                            <div class="d-flex gap-2 mb-3">
                                                 <div class="flex-grow-1 p-2 bg-white border rounded-3 text-center shadow-sm">
                                                     <small class="text-muted d-block lh-1 mb-1" style="font-size: 0.65rem;">Total Spent</small>
                                                     <div class="fw-bold">₹{{ user.totalSpent }}</div>
                                                 </div>
                                                 <div class="flex-grow-1 p-2 bg-white border rounded-3 text-center shadow-sm">
                                                     <small class="text-muted d-block lh-1 mb-1" style="font-size: 0.65rem;">Total Orders</small>
                                                     <div class="fw-bold">{{ user.totalOrders }}</div>
                                                 </div>
                                            </div>

                                            <div class="d-flex gap-2">
                                                <button (click)="quickAddWallet(user, $event)" class="btn btn-success flex-grow-1 rounded-3 py-2 fw-bold text-white shadow-sm">
                                                    <i class="bi bi-plus-lg"></i> Add
                                                </button>
                                                <button (click)="quickReduceWallet(user, $event)" [disabled]="user.walletBalance === 0" class="btn btn-warning flex-grow-1 rounded-3 py-2 fw-bold text-white shadow-sm">
                                                    <i class="bi bi-dash"></i> Reduce
                                                </button>
                                                <button (click)="deleteUser(user, $event)" class="btn btn-danger rounded-3 py-2 px-3 fw-bold text-white shadow-sm" title="Delete User">
                                                    <i class="bi bi-trash-fill"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            } @empty {
                                <div class="col-12 py-5 text-center text-muted">
                                    <i class="bi bi-search display-1 opacity-25"></i>
                                    <h4 class="mt-3">No users found</h4>
                                </div>
                            }
                        </div>
                    }
                }

             </div>
        </div>
    </div>
</div>

<!-- Reusing existing Modals (simplified styles needed via global or keep usage) -->
<!-- User Detail Modal -->
@if (showUserDetailModal()) {
    <div class="modal-backdrop fade show"></div>
    <div class="modal fade show d-block" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0 shadow-lg">
          <div class="modal-header border-0 pb-0">
            <h5 class="modal-title fw-bold">User Details</h5>
            <button type="button" class="btn-close" (click)="closeUserDetailModal()"></button>
          </div>
          <div class="modal-body">
             <div class="text-center mb-4">
                 <div class="mx-auto rounded-circle mb-3 d-flex align-items-center justify-content-center text-white fw-bold shadow-sm"
                      [style.background]="getRandomGradient(selectedDetailUser()!.id)" style="width: 80px; height: 80px; font-size: 1.5rem;">
                      {{ getUserInitials(selectedDetailUser()!.name) }}
                 </div>
                 <h4 class="fw-bold mb-1">{{ selectedDetailUser()!.name }}</h4>
                 <p class="text-muted mb-2">{{ selectedDetailUser()!.email }}</p>
                 <span class="badge bg-light text-dark border">{{ selectedDetailUser()!.registrationNumber }}</span>
             </div>
             
             <div class="card bg-light border-0 rounded-4 p-3 mb-3">
                 <div class="d-flex justify-content-between align-items-center mb-2">
                     <span class="text-muted fw-bold small text-uppercase">Current Balance</span>
                     <span class="text-success fw-bold">Total Spent: ₹{{ selectedDetailUser()!.totalSpent }}</span>
                 </div>
                 <h2 class="fw-bold text-dark mb-3">₹{{ selectedDetailUser()!.walletBalance }}</h2>
                 <div class="d-flex gap-2">
                     <button class="btn btn-primary flex-grow-1 rounded-pill" (click)="openAddWalletModal(selectedDetailUser()!)">Add Balance</button>
                     <button class="btn btn-outline-danger flex-grow-1 rounded-pill" (click)="openReduceWalletModal(selectedDetailUser()!)">Reduce</button>
                 </div>
             </div>
          </div>
        </div>
      </div>
    </div>
}

<!-- Wallet Modal -->
@if (showWalletModal()) {
    <div class="modal-backdrop fade show"></div>
    <div class="modal fade show d-block" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content rounded-4 border-0 shadow-lg">
          <div class="modal-header border-0">
            <h5 class="modal-title fw-bold">{{ isAddingWallet() ? 'Add Balance' : 'Reduce Balance' }}</h5>
            <button type="button" class="btn-close" (click)="closeWalletModal()"></button>
          </div>
          <div class="modal-body pt-0">
             <div class="mb-3">
                 <label class="form-label small fw-bold text-muted">Amount</label>
                 <div class="input-group">
                     <span class="input-group-text bg-light border-0 fw-bold">₹</span>
                     <input type="number" class="form-control bg-light border-0 fw-bold" [ngModel]="walletAmount()" (ngModelChange)="walletAmount.set($event)" placeholder="0">
                 </div>
             </div>
             <div class="mb-4">
                <label class="form-label small fw-bold text-muted">Reason (Optional)</label>
                <textarea class="form-control bg-light border-0" rows="2" [ngModel]="walletReason()" (ngModelChange)="walletReason.set($event)"></textarea>
             </div>
             <button class="btn w-100 rounded-pill fw-bold py-2" 
                [class.btn-success]="isAddingWallet()" 
                [class.btn-danger]="!isAddingWallet()" 
                (click)="submitWallet()"
                [disabled]="processingWallet()">
                 {{ isAddingWallet() ? 'Confirm Add' : 'Confirm Reduce' }}
             </button>
          </div>
        </div>
      </div>
    </div>
}

<!-- Create User Modal -->
@if (showCreateUserModal()) {
    <div class="modal-backdrop fade show"></div>
    <div class="modal fade show d-block" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0 shadow-lg">
          <div class="modal-header border-0 pb-0">
            <h5 class="modal-title fw-bold">Add New User</h5>
            <button type="button" class="btn-close" (click)="closeCreateUserModal()"></button>
          </div>
          <div class="modal-body">
             <div class="mb-3">
                 <label class="form-label small fw-bold text-muted">Full Name</label>
                 <input type="text" class="form-control bg-light border-0" [ngModel]="newUser().name" (ngModelChange)="newUser.set({...newUser(), name: $event})" placeholder="e.g. John Doe">
             </div>
             <div class="mb-3">
                 <label class="form-label small fw-bold text-muted">College Email</label>
                 <input type="email" class="form-control bg-light border-0" [ngModel]="newUser().email" (ngModelChange)="newUser.set({...newUser(), email: $event})" placeholder="student@college.edu">
             </div>
             <div class="mb-3">
                 <label class="form-label small fw-bold text-muted">Registration Number</label>
                 <input type="text" class="form-control bg-light border-0 text-uppercase" [ngModel]="newUser().registrationNumber" (ngModelChange)="newUser.set({...newUser(), registrationNumber: $event})" placeholder="e.g. 21CSR001">
             </div>
             <div class="row g-3 mb-4">
                 <div class="col-6">
                     <label class="form-label small fw-bold text-muted">Department</label>
                     <input type="text" class="form-control bg-light border-0" [ngModel]="newUser().department" (ngModelChange)="newUser.set({...newUser(), department: $event})" placeholder="e.g. CSE">
                 </div>
                 <div class="col-6">
                     <label class="form-label small fw-bold text-muted">Year</label>
                     <input type="number" class="form-control bg-light border-0" [ngModel]="newUser().year" (ngModelChange)="newUser.set({...newUser(), year: +$event})" placeholder="e.g. 3">
                 </div>
             </div>
             <div class="mb-4">
                 <label class="form-label small fw-bold text-muted d-block">User Type</label>
                 <div class="btn-group w-100" role="group">
                     <input type="radio" class="btn-check" name="userType" id="dayScholar" [checked]="newUser().userType === 'dayscholar'" (change)="newUser.set({...newUser(), userType: 'dayscholar'})">
                     <label class="btn btn-outline-warning fw-bold" for="dayScholar">Day Scholar</label>

                     <input type="radio" class="btn-check" name="userType" id="hosteller" [checked]="newUser().userType === 'hosteller'" (change)="newUser.set({...newUser(), userType: 'hosteller'})">
                     <label class="btn btn-outline-secondary fw-bold" for="hosteller">Hosteller</label>
                 </div>
             </div>

             <button class="btn btn-primary w-100 rounded-pill fw-bold py-3" (click)="submitCreateUser()" [disabled]="creatingUser()">
                 {{ creatingUser() ? 'Creating User...' : 'Create User' }}
             </button>
          </div>
        </div>
      </div>
    </div>
}

<!-- Toast replacement (Standard Bootstrap Toast) -->
@if (showToast()) {
    <div class="position-fixed top-0 start-50 translate-middle-x mt-4 p-3" style="z-index: 2000">
        <div class="toast show align-items-center text-white bg-dark border-0 shadow-lg" role="alert">
            <div class="d-flex">
                <div class="toast-body d-flex align-items-center gap-2">
                    <i class="bi" [class.bi-check-circle-fill]="toastType() === 'success'" [class.bi-exclamation-circle-fill]="toastType() === 'error'"></i>
                    {{ toastMessage() }}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" (click)="showToast.set(false)"></button>
            </div>
        </div>
    </div>
}
