<div class="dashboard-container">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo">
        <div class="logo-icon">
          <i class="bi bi-wallet2"></i>
        </div>
        <div class="logo-text">
          <span class="brand">Campus Canteen</span>
          <span class="admin-badge">Admin Panel</span>
        </div>
      </div>
    </div>

    <nav class="sidebar-nav">
      <button 
        class="nav-item" 
        [class.active]="activeTab() === 'stats'"
        (click)="setActiveTab('stats')"
      >
        <i class="bi bi-grid-1x2-fill"></i>
        <span>Dashboard</span>
      </button>
      <button 
        class="nav-item" 
        [class.active]="activeTab() === 'users'"
        (click)="setActiveTab('users')"
      >
        <i class="bi bi-people-fill"></i>
        <span>Users & Wallets</span>
      </button>
    </nav>

    <div class="sidebar-footer">
      <div class="admin-info">
        <div class="admin-avatar-small">
          <i class="bi bi-shield-check"></i>
        </div>
        <div class="admin-details">
          <span class="admin-name">Administrator</span>
          <span class="admin-role">Full Access</span>
        </div>
      </div>
      <button class="logout-btn" (click)="logout()">
        <i class="bi bi-box-arrow-left"></i>
        <span>Logout</span>
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Header -->
    <header class="main-header">
      <div class="header-left">
        <h1 class="page-title">
          @if (activeTab() === 'stats') {
            <i class="bi bi-graph-up-arrow"></i>
            Dashboard Overview
          } @else {
            <i class="bi bi-wallet2"></i>
            Wallet Management
          }
        </h1>
        <p class="page-subtitle">
          {{ activeTab() === 'stats' ? 'Real-time analytics and statistics' : 'Manage user wallets and view details' }}
        </p>
      </div>
      <div class="header-right">
        <div class="header-stats">
          @if (dashboardStats()) {
            <div class="mini-stat">
              <span class="mini-stat-value">{{ dashboardStats()!.totalUsers }}</span>
              <span class="mini-stat-label">Users</span>
            </div>
            <div class="mini-stat">
              <span class="mini-stat-value">{{ dashboardStats()!.totalPointsDistributed }}</span>
              <span class="mini-stat-label">Points</span>
            </div>
          }
        </div>
      </div>
    </header>

    <!-- Stats Tab -->
    @if (activeTab() === 'stats') {
      <section class="stats-section">
        @if (dashboardStats()) {
          <div class="stats-grid">
            <div class="stat-card gradient-1">
              <div class="stat-card-bg"></div>
              <div class="stat-icon">
                <i class="bi bi-people-fill"></i>
              </div>
              <div class="stat-info">
                <span class="stat-value">{{ dashboardStats()!.totalUsers }}</span>
                <span class="stat-label">Total Users</span>
              </div>
              <div class="stat-trend up">
                <i class="bi bi-arrow-up-short"></i>
                Active
              </div>
            </div>

            <div class="stat-card gradient-2">
              <div class="stat-card-bg"></div>
              <div class="stat-icon">
                <i class="bi bi-mortarboard-fill"></i>
              </div>
              <div class="stat-info">
                <span class="stat-value">{{ dashboardStats()!.totalDayScholars }}</span>
                <span class="stat-label">Day Scholars</span>
              </div>
              <div class="stat-percent">
                {{ dashboardStats()!.totalUsers > 0 ? ((dashboardStats()!.totalDayScholars / dashboardStats()!.totalUsers) * 100).toFixed(0) : 0 }}%
              </div>
            </div>

            <div class="stat-card gradient-3">
              <div class="stat-card-bg"></div>
              <div class="stat-icon">
                <i class="bi bi-house-heart-fill"></i>
              </div>
              <div class="stat-info">
                <span class="stat-value">{{ dashboardStats()!.totalHostellers }}</span>
                <span class="stat-label">Hostellers</span>
              </div>
              <div class="stat-percent">
                {{ dashboardStats()!.totalUsers > 0 ? ((dashboardStats()!.totalHostellers / dashboardStats()!.totalUsers) * 100).toFixed(0) : 0 }}%
              </div>
            </div>

            <div class="stat-card gradient-4">
              <div class="stat-card-bg"></div>
              <div class="stat-icon">
                <i class="bi bi-coin"></i>
              </div>
              <div class="stat-info">
                <span class="stat-value">{{ dashboardStats()!.totalPointsDistributed }}</span>
                <span class="stat-label">Total Points</span>
              </div>
              <div class="stat-trend up">
                <i class="bi bi-stars"></i>
                Distributed
              </div>
            </div>

            <div class="stat-card gradient-5">
              <div class="stat-card-bg"></div>
              <div class="stat-icon">
                <i class="bi bi-person-plus-fill"></i>
              </div>
              <div class="stat-info">
                <span class="stat-value">{{ dashboardStats()!.recentUsers }}</span>
                <span class="stat-label">New Users (7 days)</span>
              </div>
              <div class="stat-trend up">
                <i class="bi bi-graph-up"></i>
                Recent
              </div>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="quick-actions-section">
            <h2 class="section-title">Quick Actions</h2>
            <div class="quick-actions">
              <button class="quick-action-btn" (click)="setActiveTab('users')">
                <i class="bi bi-wallet-fill"></i>
                <span>Manage Wallets</span>
              </button>
              <button class="quick-action-btn" (click)="loadDashboard()">
                <i class="bi bi-arrow-clockwise"></i>
                <span>Refresh Data</span>
              </button>
            </div>
          </div>
        }
      </section>
    }

    <!-- Users Tab -->
    @if (activeTab() === 'users') {
      <section class="users-section">
        <!-- Filters & Search -->
        <div class="filters-container">
          <div class="filter-tabs">
            <button 
              class="filter-tab" 
              [class.active]="filterType() === 'all'"
              (click)="onFilterChange('all')"
            >
              <i class="bi bi-grid"></i>
              All Users
              <span class="filter-count">{{ users().length }}</span>
            </button>
            <button 
              class="filter-tab" 
              [class.active]="filterType() === 'dayscholar'"
              (click)="onFilterChange('dayscholar')"
            >
              <i class="bi bi-sun"></i>
              Day Scholar
            </button>
            <button 
              class="filter-tab" 
              [class.active]="filterType() === 'hosteller'"
              (click)="onFilterChange('hosteller')"
            >
              <i class="bi bi-moon-stars"></i>
              Hosteller
            </button>
          </div>
          
          <div class="search-box">
            <i class="bi bi-search"></i>
            <input
              type="text"
              placeholder="Search by name, email, or registration number..."
              [ngModel]="searchQuery()"
              (ngModelChange)="searchQuery.set($event); onSearch()"
            />
            @if (searchQuery()) {
              <button class="clear-search" (click)="searchQuery.set(''); onSearch()">
                <i class="bi bi-x-lg"></i>
              </button>
            }
          </div>
        </div>

        <div class="results-info">
          <span class="results-count">
            <strong>{{ filteredUsers().length }}</strong> users found
          </span>
        </div>

        <!-- Loading State -->
        @if (loading()) {
          <div class="loading-state">
            <div class="spinner-container">
              <div class="spinner"></div>
            </div>
            <p>Loading users...</p>
          </div>
        }

        <!-- Error State -->
        @if (error()) {
          <div class="error-state">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <p>{{ error() }}</p>
            <button (click)="loadDashboard()">Try Again</button>
          </div>
        }

        <!-- Users Grid -->
        @if (!loading() && !error() && filteredUsers().length > 0) {
          <div class="users-grid">
            @for (user of filteredUsers(); track user.id) {
              <div class="user-card" (click)="openUserDetailModal(user)">
                <div class="user-card-glow"></div>
                <div class="user-card-header">
                  <div class="user-avatar" [style.background]="getRandomGradient(user.id)">
                    {{ getUserInitials(user.name) }}
                  </div>
                  <div class="user-type-badge" [class.hosteller]="user.userType === 'hosteller'">
                    <i [class]="user.userType === 'dayscholar' ? 'bi bi-sun-fill' : 'bi bi-moon-stars-fill'"></i>
                    {{ user.userType === 'dayscholar' ? 'Day Scholar' : 'Hosteller' }}
                  </div>
                </div>

                <div class="user-card-body">
                  <h3 class="user-name">{{ user.name }}</h3>
                  <p class="user-email">{{ user.email }}</p>
                  <div class="user-reg">
                    <i class="bi bi-person-badge-fill"></i>
                    {{ user.registrationNumber }}
                  </div>
                </div>

                <div class="wallet-section">
                  <div class="wallet-display">
                    <div class="wallet-icon">
                      <i class="bi bi-wallet2"></i>
                    </div>
                    <div class="wallet-info">
                      <span class="wallet-label">Wallet Balance</span>
                      <span class="wallet-amount">₹{{ user.walletBalance }}</span>
                    </div>
                  </div>
                  <div class="wallet-actions">
                    <button class="wallet-btn add" (click)="quickAddWallet(user, $event)" title="Add Balance">
                      <i class="bi bi-plus-lg"></i>
                    </button>
                    <button 
                      class="wallet-btn reduce" 
                      (click)="quickReduceWallet(user, $event)" 
                      title="Reduce Balance"
                      [disabled]="user.walletBalance === 0"
                    >
                      <i class="bi bi-dash-lg"></i>
                    </button>
                  </div>
                </div>

                <div class="user-card-stats">
                  <div class="stat-item">
                    <span class="stat-num">{{ user.totalOrders }}</span>
                    <span class="stat-text">Purchases</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-num">₹{{ user.totalSpent }}</span>
                    <span class="stat-text">Spent</span>
                  </div>
                </div>

                <div class="user-card-footer">
                  <span class="view-details">
                    <i class="bi bi-eye"></i>
                    View Details
                  </span>
                  <span class="joined-date">
                    <i class="bi bi-calendar3"></i>
                    {{ formatDate(user.createdAt) }}
                  </span>
                </div>
              </div>
            }
          </div>
        }

        <!-- Empty State -->
        @if (!loading() && !error() && filteredUsers().length === 0) {
          <div class="empty-state">
            <div class="empty-icon">
              <i class="bi bi-inbox"></i>
            </div>
            <h3>No users found</h3>
            <p>Try adjusting your search or filter criteria</p>
          </div>
        }
      </section>
    }
  </main>

  <!-- User Detail Modal -->
  @if (showUserDetailModal()) {
    <div class="modal-overlay" (click)="closeUserDetailModal()">
      <div class="modal-content detail-modal" (click)="$event.stopPropagation()">
        <button class="modal-close" (click)="closeUserDetailModal()">
          <i class="bi bi-x-lg"></i>
        </button>

        <div class="detail-header">
          <div class="detail-avatar" [style.background]="getRandomGradient(selectedDetailUser()!.id)">
            {{ getUserInitials(selectedDetailUser()!.name) }}
          </div>
          <div class="detail-title">
            <h2>{{ selectedDetailUser()!.name }}</h2>
            <div class="detail-badges">
              <span class="detail-type-badge" [class.hosteller]="selectedDetailUser()!.userType === 'hosteller'">
                <i [class]="selectedDetailUser()!.userType === 'dayscholar' ? 'bi bi-sun-fill' : 'bi bi-moon-stars-fill'"></i>
                {{ selectedDetailUser()!.userType === 'dayscholar' ? 'Day Scholar' : 'Hosteller' }}
              </span>
              <span class="detail-dept-badge" *ngIf="selectedDetailUser()!.department">
                {{ selectedDetailUser()!.department }}
              </span>
            </div>
          </div>
        </div>

        <div class="detail-body">
          <!-- Wallet Card -->
          <div class="detail-wallet-card">
            <div class="wallet-header">
              <i class="bi bi-wallet2"></i>
              <span>Wallet Balance</span>
            </div>
            <div class="wallet-balance">₹{{ selectedDetailUser()!.walletBalance }}</div>
            <div class="wallet-actions-bar">
              <button class="wallet-action add" (click)="openAddWalletModal(selectedDetailUser()!)">
                <i class="bi bi-plus-circle-fill"></i>
                Add Balance
              </button>
              <button 
                class="wallet-action reduce" 
                (click)="openReduceWalletModal(selectedDetailUser()!)"
                [disabled]="selectedDetailUser()!.walletBalance === 0"
              >
                <i class="bi bi-dash-circle-fill"></i>
                Reduce Balance
              </button>
            </div>
          </div>

          <!-- User Info Grid -->
          <div class="detail-info-grid">
            <div class="info-item">
              <i class="bi bi-envelope-fill"></i>
              <div class="info-content">
                <span class="info-label">Email</span>
                <span class="info-value">{{ selectedDetailUser()!.email }}</span>
              </div>
            </div>
            <div class="info-item">
              <i class="bi bi-person-badge-fill"></i>
              <div class="info-content">
                <span class="info-label">Registration Number</span>
                <span class="info-value">{{ selectedDetailUser()!.registrationNumber }}</span>
              </div>
            </div>
            <div class="info-item">
              <i class="bi bi-building"></i>
              <div class="info-content">
                <span class="info-label">Department</span>
                <span class="info-value">{{ selectedDetailUser()!.department || 'Not Set' }}</span>
              </div>
            </div>
            <div class="info-item">
              <i class="bi bi-calendar-event"></i>
              <div class="info-content">
                <span class="info-label">Year</span>
                <span class="info-value">{{ selectedDetailUser()!.year ? 'Year ' + selectedDetailUser()!.year : 'Not Set' }}</span>
              </div>
            </div>
            <div class="info-item">
              <i class="bi bi-calendar-check"></i>
              <div class="info-content">
                <span class="info-label">Joined</span>
                <span class="info-value">{{ formatDateTime(selectedDetailUser()!.createdAt) }}</span>
              </div>
            </div>
          </div>

          <!-- Stats Row -->
          <div class="detail-stats-row">
            <div class="detail-stat">
              <div class="detail-stat-icon orders">
                <i class="bi bi-bag-check"></i>
              </div>
              <div class="detail-stat-info">
                <span class="detail-stat-value">{{ selectedDetailUser()!.totalOrders }}</span>
                <span class="detail-stat-label">Total Purchases</span>
              </div>
            </div>
            <div class="detail-stat">
              <div class="detail-stat-icon spent">
                <i class="bi bi-currency-rupee"></i>
              </div>
              <div class="detail-stat-info">
                <span class="detail-stat-value">₹{{ selectedDetailUser()!.totalSpent }}</span>
                <span class="detail-stat-label">Total Spent</span>
              </div>
            </div>
          </div>

          <!-- Password Section -->
          <div class="password-section">
            <div class="password-header">
              <i class="bi bi-shield-lock-fill"></i>
              <span>Password Management</span>
            </div>
            <p class="password-info">Reset user's password if they've forgotten it or need to update it.</p>
            <button class="reset-password-btn" (click)="openPasswordModal(selectedDetailUser()!)">
              <i class="bi bi-key-fill"></i>
              Reset Password
            </button>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- Wallet Modal -->
  @if (showWalletModal()) {
    <div class="modal-overlay" (click)="closeWalletModal()">
      <div class="modal-content wallet-modal" (click)="$event.stopPropagation()">
        <div class="modal-header" [class.reduce]="!isAddingWallet()">
          <div class="modal-icon">
            <i class="bi" [class.bi-plus-circle-fill]="isAddingWallet()" [class.bi-dash-circle-fill]="!isAddingWallet()"></i>
          </div>
          <h3>{{ isAddingWallet() ? 'Add Wallet Balance' : 'Reduce Wallet Balance' }}</h3>
          <p>{{ selectedUser()?.name }} ({{ selectedUser()?.registrationNumber }})</p>
        </div>

        <div class="modal-body">
          <div class="current-wallet-row">
            <div class="current-wallet">
              <span class="current-label">Current Balance</span>
              <span class="current-value">
                <i class="bi bi-wallet2"></i>
                ₹{{ selectedUser()?.walletBalance || 0 }}
              </span>
            </div>
            <div class="current-wallet">
              <span class="current-label">Total Spent</span>
              <span class="current-value">
                <i class="bi bi-currency-rupee"></i>
                ₹{{ selectedUser()?.totalSpent || 0 }}
              </span>
            </div>
          </div>

          <div class="form-group">
            <label for="walletAmount">Amount (₹)</label>
            <div class="amount-input-wrapper">
              <span class="currency-symbol">₹</span>
              <input
                id="walletAmount"
                type="number"
                placeholder="Enter amount"
                min="1"
                [max]="isAddingWallet() ? 100000 : (selectedUser()?.walletBalance ?? 0)"
                [ngModel]="walletAmount()"
                (ngModelChange)="walletAmount.set($event)"
              />
            </div>
            @if (!isAddingWallet() && walletAmount() > (selectedUser()?.walletBalance ?? 0)) {
              <span class="input-error">Cannot exceed current balance</span>
            }
          </div>

          <div class="form-group">
            <label for="walletReason">Reason (Optional)</label>
            <textarea
              id="walletReason"
              placeholder="Enter reason for balance change..."
              rows="3"
              [ngModel]="walletReason()"
              (ngModelChange)="walletReason.set($event)"
            ></textarea>
          </div>

          <div class="preview-section">
            <span class="preview-label">New Balance</span>
            <span class="preview-value" [class.increase]="isAddingWallet()" [class.decrease]="!isAddingWallet()">
              ₹{{ isAddingWallet() 
                ? (selectedUser()?.walletBalance || 0) + walletAmount() 
                : Math.max(0, (selectedUser()?.walletBalance || 0) - walletAmount()) }}
            </span>
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn-cancel" (click)="closeWalletModal()">Cancel</button>
          <button 
            class="btn-submit" 
            [class.reduce]="!isAddingWallet()"
            (click)="submitWallet()" 
            [disabled]="processingWallet() || walletAmount() <= 0 || (!isAddingWallet() && walletAmount() > (selectedUser()?.walletBalance ?? 0))"
          >
            @if (processingWallet()) {
              <span class="btn-spinner"></span>
            } @else {
              <i [class]="isAddingWallet() ? 'bi bi-plus-circle-fill' : 'bi bi-dash-circle-fill'"></i>
              {{ isAddingWallet() ? 'Add Balance' : 'Reduce Balance' }}
            }
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Password Reset Modal -->
  @if (showPasswordModal()) {
    <div class="modal-overlay" (click)="closePasswordModal()">
      <div class="modal-content password-modal" (click)="$event.stopPropagation()">
        <div class="modal-header password-header">
          <div class="modal-icon">
            <i class="bi bi-key-fill"></i>
          </div>
          <h3>Reset Password</h3>
          <p>{{ selectedUser()?.name }} ({{ selectedUser()?.registrationNumber }})</p>
        </div>

        <div class="modal-body">
          <div class="form-group">
            <label for="newPassword">New Password</label>
            <div class="password-input-wrapper">
              <input
                id="newPassword"
                [type]="showNewPassword() ? 'text' : 'password'"
                placeholder="Enter new password"
                minlength="6"
                [ngModel]="newPassword()"
                (ngModelChange)="newPassword.set($event)"
              />
              <button class="toggle-password" (click)="togglePasswordVisibility('new')" type="button">
                <i [class]="showNewPassword() ? 'bi bi-eye-slash' : 'bi bi-eye'"></i>
              </button>
            </div>
            @if (newPassword() && newPassword().length < 6) {
              <span class="input-error">Password must be at least 6 characters</span>
            }
          </div>

          <div class="form-group">
            <label for="confirmPassword">Confirm Password</label>
            <div class="password-input-wrapper">
              <input
                id="confirmPassword"
                [type]="showConfirmPassword() ? 'text' : 'password'"
                placeholder="Confirm new password"
                [ngModel]="confirmPassword()"
                (ngModelChange)="confirmPassword.set($event)"
              />
              <button class="toggle-password" (click)="togglePasswordVisibility('confirm')" type="button">
                <i [class]="showConfirmPassword() ? 'bi bi-eye-slash' : 'bi bi-eye'"></i>
              </button>
            </div>
            @if (confirmPassword() && newPassword() !== confirmPassword()) {
              <span class="input-error">Passwords do not match</span>
            }
          </div>

          <div class="password-requirements">
            <span class="req-title">Password Requirements:</span>
            <ul>
              <li [class.met]="newPassword().length >= 6">
                <i [class]="newPassword().length >= 6 ? 'bi bi-check-circle-fill' : 'bi bi-circle'"></i>
                At least 6 characters
              </li>
              <li [class.met]="newPassword() && newPassword() === confirmPassword()">
                <i [class]="newPassword() && newPassword() === confirmPassword() ? 'bi bi-check-circle-fill' : 'bi bi-circle'"></i>
                Passwords match
              </li>
            </ul>
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn-cancel" (click)="closePasswordModal()">Cancel</button>
          <button 
            class="btn-submit password-submit"
            (click)="submitPasswordReset()" 
            [disabled]="processingPassword() || newPassword().length < 6 || newPassword() !== confirmPassword()"
          >
            @if (processingPassword()) {
              <span class="btn-spinner"></span>
            } @else {
              <i class="bi bi-check-circle-fill"></i>
              Reset Password
            }
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Toast -->
  @if (showToast()) {
    <div class="toast" [class.success]="toastType() === 'success'" [class.error]="toastType() === 'error'">
      <i class="bi" [class.bi-check-circle-fill]="toastType() === 'success'" [class.bi-x-circle-fill]="toastType() === 'error'"></i>
      <span>{{ toastMessage() }}</span>
    </div>
  }
</div>
